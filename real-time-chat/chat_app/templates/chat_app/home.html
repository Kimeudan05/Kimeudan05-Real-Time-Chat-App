<!-- templates/chat_app/home.html -->
{% extends 'chat_app/base_chat.html' %}
{% load crispy_forms_tags %}

{% block title %}Chat Dashboard{% endblock %}

{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
    <!-- Left Sidebar - Rooms & Online Users -->
    <div class="lg:col-span-1 space-y-6">
        <!-- Create Room Button -->
        <div class="bg-white rounded-xl shadow p-4">
            <button onclick="document.getElementById('createRoomModal').classList.remove('hidden')" 
                    class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-2.5 rounded-lg font-medium transition flex items-center justify-center space-x-2">
                <i class="fas fa-plus"></i>
                <span>Create Room</span>
            </button>
        </div>

        <!-- Public Rooms -->
        <div class="bg-white rounded-xl shadow">
            <div class="p-4 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-800 flex items-center space-x-2">
                    <i class="fas fa-users text-indigo-600"></i>
                    <span>Public Rooms</span>
                </h3>
            </div>
            <div class="max-h-96 overflow-y-auto scrollbar-thin">
                {% for room in public_rooms %}
                    <a href="{% url 'chat-room' room.id %}" 
                       class="flex items-center justify-between p-4 hover:bg-gray-50 border-b border-gray-100">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 rounded-lg bg-indigo-100 flex items-center justify-center">
                                <i class="fas fa-hashtag text-indigo-600"></i>
                            </div>
                            <div>
                                <h4 class="font-medium text-gray-900">{{ room.name }}</h4>
                                <p class="text-sm text-gray-500">{{ room.participants.count }} members</p>
                            </div>
                        </div>
                        {% if user in room.participants.all %}
                            <span class="px-2 py-1 text-xs bg-green-100 text-green-800 rounded-full">Joined</span>
                        {% endif %}
                    </a>
                {% empty %}
                    <div class="p-4 text-center text-gray-500">
                        <i class="fas fa-inbox text-2xl mb-2"></i>
                        <p>No public rooms yet</p>
                    </div>
                {% endfor %}
            </div>
        </div>

        <!-- Online Users -->
        <div class="bg-white rounded-xl shadow">
            <div class="p-4 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-800 flex items-center space-x-2">
                    <i class="fas fa-wifi text-green-600"></i>
                    <span>Online Users</span>
                    <span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full">{{ online_users.count }}</span>
                </h3>
            </div>
            <div class="max-h-96 overflow-y-auto scrollbar-thin" id="onlineUsersList">
                {% for online_user in online_users %}
                    <div class="p-3 hover:bg-gray-50 border-b border-gray-100 flex items-center justify-between" 
                         data-user-id="{{ online_user.id }}">
                        <div class="flex items-center space-x-3">
                            <div class="relative">
                                <div class="w-10 h-10 rounded-full bg-blue-500 flex items-center justify-center text-white font-semibold">
                                    {{ online_user.username|slice:":1"|upper }}
                                </div>
                                <div class="status-indicator w-3 h-3 bg-green-500 rounded-full border-2 border-white absolute -bottom-0.5 -right-0.5"></div>
                            </div>
                            <div>
                                <h4 class="font-medium text-gray-900">{{ online_user.username }}</h4>
                                <span class="online-status text-green-500 text-xs">
                                    <i class="fas fa-circle text-xs"></i> Online
                                </span>
                            </div>
                        </div>
                        <button onclick="startDirectMessage('{{ online_user.username }}')" 
                                class="text-gray-400 hover:text-indigo-600 p-2 rounded-full hover:bg-gray-100"
                                title="Send message">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                {% empty %}
                    <div class="p-4 text-center text-gray-500">
                        <i class="fas fa-user-slash text-2xl mb-2"></i>
                        <p>No other users online</p>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Main Content - Direct Messages -->
    <div class="lg:col-span-3">
        <div class="bg-white rounded-xl shadow">
            <div class="p-6 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h2 class="text-2xl font-bold text-gray-900 flex items-center space-x-3">
                        <i class="fas fa-comment-dots text-indigo-600"></i>
                        <span>Direct Messages</span>
                    </h2>
                    <button onclick="document.getElementById('startDMModal').classList.remove('hidden')" 
                            class="bg-gray-100 hover:bg-gray-200 text-gray-800 px-4 py-2 rounded-lg font-medium transition flex items-center space-x-2">
                        <i class="fas fa-user-plus"></i>
                        <span>New Message</span>
                    </button>
                </div>
            </div>

            <div class="p-6">
                {% if dm_rooms %}
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        {% for room in dm_groups %}
                        {% for participant in room.participants.all %}
                            {% if participant != user %}
                                <a href="{% url 'chat-room' room.id %}" class="...">
                                    <div class="flex items-center space-x-4">
                                        <div class="relative">
                                            <div class="w-12 h-12 rounded-full bg-gradient-to-r from-blue-500 to-purple-500 flex items-center justify-center text-white font-semibold text-lg">
                                                {{ participant.username|slice:":1"|upper }}
                                            </div>
                                            {% if participant.is_online %}
                                                <div class="absolute -bottom-0.5 -right-0.5 w-4 h-4 bg-green-500 rounded-full border-2 border-white"></div>
                                            {% endif %}
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <h4 class="font-semibold text-gray-900 truncate">{{ participant.username }}</h4>
                                            {# ... rest of your last message logic ... #}
                                        </div>
                                    </div>
                                </a>
                            {% endif %}
                        {% endfor %}
                    {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-12">
                        <div class="w-24 h-24 mx-auto bg-gray-100 rounded-full flex items-center justify-center mb-6">
                            <i class="fas fa-comments text-gray-400 text-3xl"></i>
                        </div>
                        <h3 class="text-xl font-semibold text-gray-700 mb-2">No direct messages yet</h3>
                        <p class="text-gray-500 mb-6">Start a conversation with someone!</p>
                        <button onclick="document.getElementById('startDMModal').classList.remove('hidden')" 
                                class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-lg font-medium transition inline-flex items-center space-x-2">
                            <i class="fas fa-user-plus"></i>
                            <span>Start a Conversation</span>
                        </button>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- User Status Card -->
        <div class="bg-white rounded-xl shadow mt-6 p-6">
            <div class="flex items-center space-x-4">
                <div class="relative">
                    <div class="w-16 h-16 rounded-full bg-gradient-to-r from-indigo-500 to-purple-600 flex items-center justify-center text-white font-bold text-xl">
                        {{ user.username|slice:":1"|upper }}
                    </div>
                    <div class="absolute -bottom-0.5 -right-0.5 w-5 h-5 bg-green-500 rounded-full border-4 border-white"></div>
                </div>
                <div class="flex-1">
                    <h3 class="text-xl font-bold text-gray-900">{{ user.username }}</h3>
                    <div class="flex items-center space-x-4 mt-2">
                        <span class="flex items-center space-x-2 text-gray-600">
                            <i class="fas fa-users text-gray-400"></i>
                            <span>{{ user.chat_rooms.count }} Rooms</span>
                        </span>
                        <span class="flex items-center space-x-2 text-gray-600">
                            <i class="fas fa-comment text-gray-400"></i>
                            <span>{{ user.sent_messages.count }} Messages</span>
                        </span>
                        <span class="flex items-center space-x-2 text-green-600">
                            <i class="fas fa-circle text-xs"></i>
                            <span>Online</span>
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modals -->
{% include 'chat_app/create_room_modal.html' %}
{% include 'chat_app/start_dm_modal.html' %}

{% endblock %}

{% block extra_js %}
<script>
    // Set global user ID for WebSocket
    window.userId = {{ user.id|default:"null" }};

    function startDirectMessage(username) {
        document.getElementById('id_username').value = username;
        document.getElementById('startDMModal').classList.remove('hidden');
    }

    // Auto-refresh online users every 30 seconds
    setInterval(() => {
        fetch("{% url 'online-users' %}")
            .then(response => response.json())
            .then(data => {
                // Update online users list
                console.log('Updated online users:', data);
            });
    }, 30000);

    // Modal close functionality
    document.addEventListener('DOMContentLoaded', function() {
        // Close modals when clicking outside
        const modals = document.querySelectorAll('.modal');
        modals.forEach(modal => {
            modal.addEventListener('click', function(e) {
                if (e.target === this) {
                    this.classList.add('hidden');
                }
            });
        });

        // Close modals with escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                modals.forEach(modal => modal.classList.add('hidden'));
            }
        });
    });
</script>
{% endblock %}